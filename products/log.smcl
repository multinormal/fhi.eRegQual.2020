{smcl}
{com}{sf}{ul off}{txt}{.-}
      name:  {res}eRegQual Analysis
       {txt}log:  {res}/Users/cjr/Repos/fhi.eRegQual.2020/products/log.smcl
  {txt}log type:  {res}smcl
 {txt}opened on:  {res}11 Sep 2020, 16:14:41
{txt}
{com}. 
. // Set up Stata.
. do setup/setup
{txt}
{com}. version 16.1
{txt}
{com}. 
. // Set the random number generator seed.
. set seed 1234
{txt}
{com}. 
. // Set up Stata's path to use the "packages" directory for add-on packages.
. net set ado "./packages"
{txt}
{com}. sysdir set PERSONAL "./packages"
{txt}
{com}. 
. // Specify formats.
. set cformat %9.2f
{txt}
{com}. set pformat %5.2f
{txt}
{com}. set sformat %8.2f
{txt}
{com}. 
. 
{txt}end of do-file

{com}. 
. // Set up globals.
. do globals/globals
{txt}
{com}. version 16.1
{txt}
{com}. 
. // The number of imputations to perform.
. global m_imputations 50 // Very slightly narrower CI if m=100.
{txt}
{com}. 
. // Define the names of the process outcomes.
. global process_outcomes ""
{txt}
{com}. global process_outcomes $process_outcomes attendance hypertension diabetes
{txt}
{com}. global process_outcomes $process_outcomes malpresentation anemia fetalgrowth
{txt}
{com}. 
. // Define the names of the time outcomes.
. global time_outcomes ""
{txt}
{com}. global time_outcomes $time_outcomes him_time
{txt}
{com}. 
. // The variables to adjust for in the "main" analyses, with their "types". See
. // the generated report for an explanation of why these variables are adjusted
. // for.
. global adj_vars i.strat_var c.cluster_size c.age i.lab_available i.primiparous
{txt}
{com}. global adj_var_names // A global with just the *names* of the adj_vars
{txt}
{com}. foreach x of global adj_vars {c -(}
{txt}  2{com}.   local x_name = substr("`x'", 3, .) // Remove the i. or c.
{txt}  3{com}.   global adj_var_names $adj_var_names `x_name'
{txt}  4{com}. {c )-}
{txt}
{com}. 
. // The variables to adjust for in the time and motion analyses, with their
. // "types". See the generated report for an explanation of why these variables
. // are adjusted for. Note that unlike the "main" outcomes, data are not 
. // available for age and parity, which were used as constraints in the
. // randomization.
. global time_adj_vars i.strat_var c.cluster_size i.lab_available
{txt}
{com}. global time_adj_var_names // A global with just the *names* of the time_adj_vars
{txt}
{com}. foreach x of global time_adj_vars {c -(}
{txt}  2{com}.   local x_name = substr("`x'", 3, .) // Remove the i. or c.
{txt}  3{com}.   global time_adj_var_names $time_adj_var_names `x_name'
{txt}  4{com}. {c )-}
{txt}
{com}. 
. // Define paths to the process outcome files.
. global fname_attendance      "data/raw/25June2020_eRegQual process outcomes_attendance.dta"
{txt}
{com}. global fname_hypertension    "data/raw/25June2020_eRegQual process outcomes_hypertension.dta"
{txt}
{com}. global fname_diabetes        "data/raw/25June2020_eRegQual process outcomes_diabetes.dta"
{txt}
{com}. global fname_malpresentation "data/raw/25June2020_eRegQual process outcomes_malpresentation.dta"
{txt}
{com}. global fname_anemia          "data/raw/02July2020_eRegQual process outcomes_anemia.dta"
{txt}
{com}. global fname_fetalgrowth     "data/raw/10August2020_eRegQual process outcomes_fetalgrowth.dta"
{txt}
{com}. 
. // Define paths to the time outcome file.
. global fname_time            "data/raw/02Sep2020_eRegTime.dta"
{txt}
{com}. 
. // Define data signatures for the process outcome files.
. global datasignature_attendance          "6367:39(51496):3578513271:2127801624"
{txt}
{com}. global datasignature_hypertension        "6367:60(68365):3970041110:3735367683"
{txt}
{com}. global datasignature_diabetes            "6367:38(91264):1895688975:3113856828"
{txt}
{com}. global datasignature_malpresentation     "6367:31(88392):1586201653:3483051938"
{txt}
{com}. global datasignature_anemia              "6367:51(74410):3453863737:2485498443"
{txt}
{com}. global datasignature_fetalgrowth         "6367:37(83879):2470058122:813121498"
{txt}
{com}. 
. // Define data signature for the time data.
. global datasignature_time                "241:25(46964):1322369528:1413582791"
{txt}
{com}. 
. // Define recoding rules for the arm variables of the process outcomes; the 
. // coding of control and intervention vary by outcome. We will adopt the 
. // convention that control is coded as 1 and intervention as 2.
. global recode_attendance   recode arm (1 = 2) (2 = 1)
{txt}
{com}. global recode_hypertension recode arm (1 = 2) (2 = 1)
{txt}
{com}. foreach x in diabetes malpresentation anemia fetalgrowth {c -(}
{txt}  2{com}.   global recode_`x' // No recoding necessary
{txt}  3{com}. {c )-}
{txt}
{com}. 
{txt}end of do-file

{com}. 
. // Import the data.
. do data/process_outcomes
{txt}
{com}. version 16.1
{txt}
{com}. 
. // Record the maximum percentage of data missing for age for process outcomes.
. global max_miss_age_pc 0
{txt}
{com}. 
. foreach outcome of global process_outcomes {c -(}
{txt}  2{com}.   frame create `outcome'
{txt}  3{com}.   frame `outcome' {c -(}
{txt}  4{com}.     // Load the data and check its signature is as expected.
.     use "${c -(}fname_`outcome'{c )-}", replace
{txt}  5{com}.     datasignature
{txt}  6{com}.     assert r(datasignature) == "${c -(}datasignature_`outcome'{c )-}"
{txt}  7{com}. 
.     // Encode/rename arm and cluster identifier variables.
.     encode prettyExposure, generate(arm)
{txt}  8{com}.     rename str_TRIAL_1_Cluster clusterid
{txt}  9{com}. 
.     // Compute the cluster size from the trial data. We use the trial data for
.     // simplicity and have verified that these agree with the "baseline" data on
.     // trial size. We divide by 100 because cluster sizes range from about 10 to
.     // about 220, and we want to get regression coefficients that are non-null
.     // within two decimal places! Note that cluster size computation must be
.     // done before the data set is reshaped to long format, or we will count
.     // one enrollment per visit rather than pregnancy.
.     by clusterid, sort: generate cluster_size = _N / 100
{txt} 10{com}. 
.     // Reshape to long format. Note that the uniqueid variable is not actually
.     // unique but identifies women, who can have multiple pregnancies (but not
.     // twins in this data set). Rows in the wide data frame are pregnancies, so
.     // we simply generate a unique pregnancy number for each row. We generate a 
.     // visit variable, as each woman (pregnancy) may attend clinic multiple times. 
.     generate pregnancy = _n
{txt} 11{com}.     local stubs opportunity_`outcome'_ success_`outcome'_
{txt} 12{com}.     reshape long `stubs', i(pregnancy) j(visit)
{txt} 13{com}. 
.     // While the outcome variable is a factor with three levels, we are only 
.     // interested in the relative odds of success. The other levels are 
.     // "NOT SUCCESSFUL" and "NOT APPLICABLE". Not applicable is not of 
.     // scientific interest here.
.     local success_label_name = "`: value label success_`outcome'_'"
{txt} 14{com}.     drop if      success_`outcome'_ == "NOT APPLICABLE":`success_label_name'
{txt} 15{com}.     generate y = success_`outcome'_ == "SUCCESSFUL":`success_label_name'
{txt} 16{com}. 
.     // Convert the stratification variable from string to integer.
.     encode bookorgdistricthashed, generate(strat_var)
{txt} 17{com}.     
.     // Generate an indicator for whether each woman is primiparous.
.     rename bookprimi primiparous
{txt} 18{com}. 
.     // Age.
.     replace age = . if age <= 1 // Correct some mis-coded values of the age variable.
{txt} 19{com}.     label variable age "Age (years)"
{txt} 20{com}. 
.     // Keep only the variables of interest.
.     keep y arm pregnancy visit clusterid $adj_var_names
{txt} 21{com}. 
.     // Label the variables
.     label variable y             "Successful `outcome'"
{txt} 22{com}.     label variable arm           "Study arm"
{txt} 23{com}.     label variable pregnancy     "Pregnancy"
{txt} 24{com}.     label variable clusterid     "Cluster"
{txt} 25{com}.     label variable strat_var     "District"
{txt} 26{com}.     label variable lab_available "Lab availability"
{txt} 27{com}.     label variable cluster_size  "Cluster size" // 100s of new enrollments
{txt} 28{com}.     label variable age           "Age (years)"
{txt} 29{com}.     label variable primiparous   "Parity"       // Indicator of primiparity.
{txt} 30{com}. 
.     // Label values and set base level where appropriate.
.     label define lab_available_label                1 "Lab"          0 "No lab"
{txt} 31{com}.     label values lab_available lab_available_label
{txt} 32{com}.     label define primiparous_label                  1 "Primi"        0 "Multi"
{txt} 33{com}.     label values primiparous   primiparous_label
{txt} 34{com}.     
.     // Recode the arm levels, ensure that level 1 is control, and set the
.     // value labels.
.     ${c -(}recode_`outcome'{c )-}
{txt} 35{com}.     fvset base 1 arm
{txt} 36{com}.     label define arm_value_label 1 "Control" 2 "Intervention"
{txt} 37{com}.     label values arm arm_value_label
{txt} 38{com}. 
.     // There should only be missing data for the age variable.
.     describe, short varlist
{txt} 39{com}.     local vars = r(varlist)
{txt} 40{com}.     local vars = ustrtrim(usubinstr("`vars'", "age", "", .))
{txt} 41{com}.     foreach x of local vars {c -(}
{txt} 42{com}.       misstable summarize `x'
{txt} 43{com}.       assert r(N_lt_dot) == .
{txt} 44{com}.     {c )-}
{txt} 45{com}. 
.     // The age variable should contain no more than 1.257% missing data.
.     misstable summarize age
{txt} 46{com}.     local miss_age_pc = 100 * (r(N_eq_dot) / (r(N_eq_dot) + r(N_lt_dot)))
{txt} 47{com}.     if `miss_age_pc' > $max_miss_age_pc global max_miss_age_pc = `miss_age_pc'
{txt} 48{com}.     drop if missing(age)
{txt} 49{com}.     assert r(N_drop) <= 300 // Ensure we did only drop a little data!
{txt} 50{com}. 
.     // For most of the process outcomes, we have multiple visits within
.     // pregnancy; we model the cluster-randomized design in the estimation.
.     // For malpresentation, there is only one visit and so cluster can be the
.     // panel variable. Note that the xtlogit-based analysis with cluster as the
.     // panel variable gives identical point estimates and confidence intervals
.     // as a melogit-based analysis with cluster as the random effect.
.     if "`outcome'" != "malpresentation" xtset pregnancy visit
{txt} 51{com}.     if "`outcome'" == "malpresentation" xtset clusterid
{txt} 52{com}.   {c )-}
{txt} 53{com}. {c )-}
  {res}6367:39(51496):3578513271:2127801624
{txt}(note: j = 1 2 3 4 5)

Data{col 36}wide{col 43}->{col 48}long
{hline 77}
Number of obs.                 {res}    6367   {txt}->{res}   31835
{txt}Number of variables            {res}      42   {txt}->{res}      35
{txt}j variable (5 values)                     ->   {res}visit
{txt}xij variables:
{res}opportunity_attendance_1 opportunity_attendance_2 ... opportunity_attendance_5{txt}->{res}opportunity_attendance_
success_attendance_1 success_attendance_2 ... success_attendance_5{txt}->{res}success_attendance_
{txt}{hline 77}
(10,132 observations deleted)
{res}{txt}(128 real changes made, 128 to missing)
(arm: 21703 changes made)

Contains data
  obs:{res}        21,703                          
{txt} vars:{res}            10                          
{txt}Sorted by: {res}pregnancy  visit
     Note: Dataset has changed since last saved.
{txt}(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
{col 64}Obs<.
{col 49}{c TLC}{hline 30}
{col 16}{c |}{col 49}{c |} Unique
{col 7}Variable {c |}{col 22}Obs=.{col 32}Obs>.{col 42}Obs<.{col 49}{c |} values{col 65}Min{col 77}Max
  {hline 13}{c +}{hline 32}{c +}{hline 30}
           age {c |}{res}       273{txt}{space 10}{res}    21,430{txt}  {c |}     31         14          44
  {hline 13}{c BT}{hline 32}{c BT}{hline 30}
(273 observations deleted)
{res}{txt}{col 8}panel variable:  {res}pregnancy (unbalanced)
{txt}{col 9}time variable:  {res}{col 25}visit, 1 to 5
{txt}{col 17}delta:  {res}1 unit
  6367:60(68365):3970041110:3735367683
{txt}(note: j = 1 2 3 4 5 6 7 8)

Data{col 36}wide{col 43}->{col 48}long
{hline 77}
Number of obs.                 {res}    6367   {txt}->{res}   50936
{txt}Number of variables            {res}      63   {txt}->{res}      50
{txt}j variable (8 values)                     ->   {res}visit
{txt}xij variables:
{res}opportunity_hypertension_1 opportunity_hypertension_2 ... opportunity_hypertension_8{txt}->{res}opportunity_hypertension_
success_hypertension_1 success_hypertension_2 ... success_hypertension_8{txt}->{res}success_hypertension_
{txt}{hline 77}
(35,383 observations deleted)
{res}{txt}(102 real changes made, 102 to missing)
(arm: 15553 changes made)

Contains data
  obs:{res}        15,553                          
{txt} vars:{res}            10                          
{txt}Sorted by: {res}pregnancy  visit
     Note: Dataset has changed since last saved.
{txt}(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
{col 64}Obs<.
{col 49}{c TLC}{hline 30}
{col 16}{c |}{col 49}{c |} Unique
{col 7}Variable {c |}{col 22}Obs=.{col 32}Obs>.{col 42}Obs<.{col 49}{c |} values{col 65}Min{col 77}Max
  {hline 13}{c +}{hline 32}{c +}{hline 30}
           age {c |}{res}       170{txt}{space 10}{res}    15,383{txt}  {c |}     32         14          45
  {hline 13}{c BT}{hline 32}{c BT}{hline 30}
(170 observations deleted)
{res}{txt}{col 8}panel variable:  {res}pregnancy (unbalanced)
{txt}{col 9}time variable:  {res}{col 25}visit, 1 to 8, but with gaps
{txt}{col 17}delta:  {res}1 unit
  6367:38(91264):1895688975:3113856828
{txt}(note: j = 1 2 3 4)
(note: success_diabetes_2 not found)

Data{col 36}wide{col 43}->{col 48}long
{hline 77}
Number of obs.                 {res}    6367   {txt}->{res}   25468
{txt}Number of variables            {res}      41   {txt}->{res}      37
{txt}j variable (4 values)                     ->   {res}visit
{txt}xij variables:
{res}opportunity_diabetes_1 opportunity_diabetes_2 ... opportunity_diabetes_4{txt}->{res}opportunity_diabetes_
success_diabetes_1 success_diabetes_2 ... success_diabetes_4{txt}->{res}success_diabetes_
{txt}{hline 77}
(13,340 observations deleted)
{res}{txt}(68 real changes made, 68 to missing)

Contains data
  obs:{res}        12,128                          
{txt} vars:{res}            10                          
{txt}Sorted by: {res}pregnancy  visit
     Note: Dataset has changed since last saved.
{txt}(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
{col 64}Obs<.
{col 49}{c TLC}{hline 30}
{col 16}{c |}{col 49}{c |} Unique
{col 7}Variable {c |}{col 22}Obs=.{col 32}Obs>.{col 42}Obs<.{col 49}{c |} values{col 65}Min{col 77}Max
  {hline 13}{c +}{hline 32}{c +}{hline 30}
           age {c |}{res}       134{txt}{space 10}{res}    11,994{txt}  {c |}     32         14          45
  {hline 13}{c BT}{hline 32}{c BT}{hline 30}
(134 observations deleted)
{res}{txt}{col 8}panel variable:  {res}pregnancy (unbalanced)
{txt}{col 9}time variable:  {res}{col 25}visit, 1 to 4, but with gaps
{txt}{col 17}delta:  {res}1 unit
  6367:31(88392):1586201653:3483051938
{txt}(note: j = 1)

Data{col 36}wide{col 43}->{col 48}long
{hline 77}
Number of obs.                 {res}    6367   {txt}->{res}    6367
{txt}Number of variables            {res}      34   {txt}->{res}      35
{txt}j variable (1 values)                     ->   {res}visit
{txt}xij variables:
          {res}opportunity_malpresentation_1   {txt}->   {res}opportunity_malpresentation_
              success_malpresentation_1   {txt}->   {res}success_malpresentation_
{txt}{hline 77}
(4,427 observations deleted)
{res}{txt}(13 real changes made, 13 to missing)

Contains data
  obs:{res}         1,940                          
{txt} vars:{res}            10                          
{txt}Sorted by: {res}pregnancy  visit
     Note: Dataset has changed since last saved.
{txt}(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
{col 64}Obs<.
{col 49}{c TLC}{hline 30}
{col 16}{c |}{col 49}{c |} Unique
{col 7}Variable {c |}{col 22}Obs=.{col 32}Obs>.{col 42}Obs<.{col 49}{c |} values{col 65}Min{col 77}Max
  {hline 13}{c +}{hline 32}{c +}{hline 30}
           age {c |}{res}        21{txt}{space 10}{res}     1,919{txt}  {c |}     30         15          44
  {hline 13}{c BT}{hline 32}{c BT}{hline 30}
(21 observations deleted)
{col 8}panel variable:  {res}clusterid (unbalanced)
  6367:51(74410):3453863737:2485498443
{txt}(note: j = 1 2 3 4 5)

Data{col 36}wide{col 43}->{col 48}long
{hline 77}
Number of obs.                 {res}    6367   {txt}->{res}   31835
{txt}Number of variables            {res}      54   {txt}->{res}      47
{txt}j variable (5 values)                     ->   {res}visit
{txt}xij variables:
{res}opportunity_anemia_1 opportunity_anemia_2 ... opportunity_anemia_5{txt}->{res}opportunity_anemia_
success_anemia_1 success_anemia_2 ... success_anemia_5{txt}->{res}success_anemia_
{txt}{hline 77}
(21,333 observations deleted)
{res}{txt}(66 real changes made, 66 to missing)

Contains data
  obs:{res}        10,502                          
{txt} vars:{res}            10                          
{txt}Sorted by: {res}pregnancy  visit
     Note: Dataset has changed since last saved.
{txt}(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
{col 64}Obs<.
{col 49}{c TLC}{hline 30}
{col 16}{c |}{col 49}{c |} Unique
{col 7}Variable {c |}{col 22}Obs=.{col 32}Obs>.{col 42}Obs<.{col 49}{c |} values{col 65}Min{col 77}Max
  {hline 13}{c +}{hline 32}{c +}{hline 30}
           age {c |}{res}       115{txt}{space 10}{res}    10,387{txt}  {c |}     32         14          45
  {hline 13}{c BT}{hline 32}{c BT}{hline 30}
(115 observations deleted)
{res}{txt}{col 8}panel variable:  {res}pregnancy (unbalanced)
{txt}{col 9}time variable:  {res}{col 25}visit, 1 to 5, but with gaps
{txt}{col 17}delta:  {res}1 unit
  6367:37(83879):2470058122:813121498
{txt}(note: j = 1 2 3)

Data{col 36}wide{col 43}->{col 48}long
{hline 77}
Number of obs.                 {res}    6367   {txt}->{res}   19101
{txt}Number of variables            {res}      40   {txt}->{res}      37
{txt}j variable (3 values)                     ->   {res}visit
{txt}xij variables:
{res}opportunity_fetalgrowth_1 opportunity_fetalgrowth_2 opportunity_fetalgrowth_3{txt}->{res}opportunity_fetalgrowth_
success_fetalgrowth_1 success_fetalgrowth_2 success_fetalgrowth_3{txt}->{res}success_fetalgrowth_
{txt}{hline 77}
(17,936 observations deleted)
{res}{txt}(4 real changes made, 4 to missing)

Contains data
  obs:{res}         1,165                          
{txt} vars:{res}            10                          
{txt}Sorted by: {res}pregnancy  visit
     Note: Dataset has changed since last saved.
{txt}(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
{col 64}Obs<.
{col 49}{c TLC}{hline 30}
{col 16}{c |}{col 49}{c |} Unique
{col 7}Variable {c |}{col 22}Obs=.{col 32}Obs>.{col 42}Obs<.{col 49}{c |} values{col 65}Min{col 77}Max
  {hline 13}{c +}{hline 32}{c +}{hline 30}
           age {c |}{res}        10{txt}{space 10}{res}     1,155{txt}  {c |}     29         15          43
  {hline 13}{c BT}{hline 32}{c BT}{hline 30}
(10 observations deleted)
{res}{txt}{col 8}panel variable:  {res}pregnancy (unbalanced)
{txt}{col 9}time variable:  {res}{col 25}visit, 1 to 3, but with a gap
{txt}{col 17}delta:  {res}1 unit
{txt}
{com}. 
{txt}end of do-file

{com}. do data/birth_outcomes
{txt}
{com}. version 16.1
{txt}
{com}. 
. // Define the path to the data and the signature we expect it to have.
. local fname "data/raw/04May2020_eRegQual birth outcomes.dta"
{txt}
{com}. local signature "6367:756(27238):862839612:1580475191"
{txt}
{com}. 
. frame create original
{txt}
{com}. frame original {c -(}
.   // Load the data and check its signature is as expected.
.   use "`fname'", replace
.   datasignature
  {res}6367:756(27238):862839612:1580475191
{com}.   assert r(datasignature) == "`signature'"
. 
.   // Globals that specify the imputed and regular variables.
.   global imputeds
.   global regulars
. 
.   // Convert the arm variable from string to integer.
.   encode prettyExposure, generate(arm)
.   label variable arm Arm
.   label define birth_outcome_arm_label 1 "Intervention" 2 "Control"
.   label values arm birth_outcome_arm_label
.   fvset base 2 arm
.   global regulars $regulars arm
. 
.   // Convert the stratification variable from string to integer.
.   encode bookorgdistricthashed, generate(strat_var)
.   label variable strat_var District
.   fvset base 1 strat_var
.   global regulars $regulars strat_var
. 
.   // Rename and label the cluster identifier variable.
.   rename str_TRIAL_1_Cluster clusterid
{res}{com}.   label variable clusterid Cluster
.   global regulars $regulars clusterid
. 
.   // Rename the components of the composite outcome.
.   rename anemia_at_birth              y1
{res}{com}.   label variable                      y1 "Anemia at birth"
.   rename severehypertension_at_birth  y2
{res}{com}.   label variable                      y2 "Severe hypertension at birth"
.   rename sga_undetected_at_birth      y3
{res}{com}.   label variable                      y3 "SGA undetected at birth"
.   rename malpres_undetected           y4
{res}{com}.   label variable                      y4 "Malpresentation undetected at birth"
.   rename lga                          y5
{res}{com}.   label variable                      y5 "Large for gestational age"
. 
.   // Apply labels to the outcomes.
.   label define yes_no_label 0 "No" 1 "Yes"
.   label values y* yes_no_label
. 
.   // Age.
.   replace age = . if age <= 1 // Correct some mis-coded values of the age variable.
{txt}(35 real changes made, 35 to missing)
{com}.   label variable age "Age (years)"
.   global imputeds $imputeds age
. 
.   // BMI.
.   rename bookbmi bmi
{res}{com}.   replace bmi = . if bmi < 15 | bmi > 48 // Same policy as for categorical version.
{txt}(54 real changes made, 54 to missing)
{com}.   label variable bmi "Body mass index"
.   global imputeds $imputeds bmi
. 
.   // Education.
.   label variable education "Education (years)"
.   global imputeds $imputeds education
. 
.   // Income.
.   generate log_income = log(avgincome) // Log to approximately normalize.
{txt}(404 missing values generated)
{com}.   label variable log_income "Monthly household income (ILS; log scale)"
.   global imputeds $imputeds log_income
. 
.   // Lab availability.
.   label variable lab_available "Lab available"
.   label define lab_available_label 1 "Lab" 0 "No lab"
.   label values lab_available lab_available_label
.   global regulars $regulars lab_available
.   
.   // Generate an indicator for whether each woman is primiparous.
.   rename bookprimi primiparous
{res}{com}.   label variable primiparous   "Parity"
.   label define primiparous_label 1 "Primi" 0 "Multi"
.   label values primiparous primiparous_label
.   global imputeds $imputeds primiparous
. 
.   // Generate an indicator for stillbirth. Because this is a secondary outcome
.   // and data are missing for <5% of women, we will not impute.
.   rename stillbirth_reported stillbirth
{res}{com}.   label variable stillbirth   "Stillbirth"
.   label define stillbirth_label 1 "Stillbirth" 0 "Live birth"
.   label values stillbirth stillbirth_label
.   
.   // Compute the cluster size from the trial data. We use the trial data for
.   // simplicity and have verified that these agree with the "baseline" data on
.   // trial size. We divide by 100 because cluster sizes range from about 10 to
.   // about 220, and we want to get regression coefficients that are non-null
.   // within two decimal places!
.   by clusterid, sort: generate cluster_size = _N / 100
.   global regulars $regulars cluster_size
. 
.   // Ultrasound available.
.   label variable us_available "US available"
.   global regulars $regulars us_available
. 
.   // Keep only the variables of interest.
.   keep y* $imputeds $regulars TrialOne_adverse_pregoutc stillbirth
. 
.   // Verify that all of the regular variables are complete, that each of the
.   // variables to be imputed contain missing values, and that the threshold on
.   // the percentage of missing data we tolerate to perform a complete case
.   // analysis applies to the stillbirth variable.
.   foreach x of global regulars {c -(}
{txt}  2{com}.     misstable summarize `x'
{txt}  3{com}.     assert r(N_lt_dot) == .
{txt}  4{com}.   {c )-}
{txt}(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
(variables nonmissing or string)
{com}.   foreach x of varlist y1-y5 $imputeds {c -(}
{txt}  2{com}.     misstable summarize `x'
{txt}  3{com}.     assert r(N_lt_dot) < _N
{txt}  4{com}.   {c )-}
{txt}{col 64}Obs<.
{col 49}{c TLC}{hline 30}
{col 16}{c |}{col 49}{c |} Unique
{col 7}Variable {c |}{col 22}Obs=.{col 32}Obs>.{col 42}Obs<.{col 49}{c |} values{col 65}Min{col 77}Max
  {hline 13}{c +}{hline 32}{c +}{hline 30}
            y1 {c |}{res}     1,743{txt}{space 10}{res}     4,624{txt}  {c |}      2          0           1
  {hline 13}{c BT}{hline 32}{c BT}{hline 30}
{col 64}Obs<.
{col 49}{c TLC}{hline 30}
{col 16}{c |}{col 49}{c |} Unique
{col 7}Variable {c |}{col 22}Obs=.{col 32}Obs>.{col 42}Obs<.{col 49}{c |} values{col 65}Min{col 77}Max
  {hline 13}{c +}{hline 32}{c +}{hline 30}
            y2 {c |}{res}     2,258{txt}{space 10}{res}     4,109{txt}  {c |}      2          0           1
  {hline 13}{c BT}{hline 32}{c BT}{hline 30}
{col 64}Obs<.
{col 49}{c TLC}{hline 30}
{col 16}{c |}{col 49}{c |} Unique
{col 7}Variable {c |}{col 22}Obs=.{col 32}Obs>.{col 42}Obs<.{col 49}{c |} values{col 65}Min{col 77}Max
  {hline 13}{c +}{hline 32}{c +}{hline 30}
            y3 {c |}{res}       752{txt}{space 10}{res}     5,615{txt}  {c |}      2          0           1
  {hline 13}{c BT}{hline 32}{c BT}{hline 30}
{col 64}Obs<.
{col 49}{c TLC}{hline 30}
{col 16}{c |}{col 49}{c |} Unique
{col 7}Variable {c |}{col 22}Obs=.{col 32}Obs>.{col 42}Obs<.{col 49}{c |} values{col 65}Min{col 77}Max
  {hline 13}{c +}{hline 32}{c +}{hline 30}
            y4 {c |}{res}       875{txt}{space 10}{res}     5,492{txt}  {c |}      2          0           1
  {hline 13}{c BT}{hline 32}{c BT}{hline 30}
{col 64}Obs<.
{col 49}{c TLC}{hline 30}
{col 16}{c |}{col 49}{c |} Unique
{col 7}Variable {c |}{col 22}Obs=.{col 32}Obs>.{col 42}Obs<.{col 49}{c |} values{col 65}Min{col 77}Max
  {hline 13}{c +}{hline 32}{c +}{hline 30}
            y5 {c |}{res}       752{txt}{space 10}{res}     5,615{txt}  {c |}      2          0           1
  {hline 13}{c BT}{hline 32}{c BT}{hline 30}
{col 64}Obs<.
{col 49}{c TLC}{hline 30}
{col 16}{c |}{col 49}{c |} Unique
{col 7}Variable {c |}{col 22}Obs=.{col 32}Obs>.{col 42}Obs<.{col 49}{c |} values{col 65}Min{col 77}Max
  {hline 13}{c +}{hline 32}{c +}{hline 30}
           age {c |}{res}        69{txt}{space 10}{res}     6,298{txt}  {c |}     32         14          45
  {hline 13}{c BT}{hline 32}{c BT}{hline 30}
{col 64}Obs<.
{col 49}{c TLC}{hline 30}
{col 16}{c |}{col 49}{c |} Unique
{col 7}Variable {c |}{col 22}Obs=.{col 32}Obs>.{col 42}Obs<.{col 49}{c |} values{col 65}Min{col 77}Max
  {hline 13}{c +}{hline 32}{c +}{hline 30}
           bmi {c |}{res}       938{txt}{space 10}{res}     5,429{txt}  {c |}   >500   15.42969    47.98243
  {hline 13}{c BT}{hline 32}{c BT}{hline 30}
{col 64}Obs<.
{col 49}{c TLC}{hline 30}
{col 16}{c |}{col 49}{c |} Unique
{col 7}Variable {c |}{col 22}Obs=.{col 32}Obs>.{col 42}Obs<.{col 49}{c |} values{col 65}Min{col 77}Max
  {hline 13}{c +}{hline 32}{c +}{hline 30}
     education {c |}{res}       203{txt}{space 10}{res}     6,164{txt}  {c |}     25          1          24
  {hline 13}{c BT}{hline 32}{c BT}{hline 30}
{col 64}Obs<.
{col 49}{c TLC}{hline 30}
{col 16}{c |}{col 49}{c |} Unique
{col 7}Variable {c |}{col 22}Obs=.{col 32}Obs>.{col 42}Obs<.{col 49}{c |} values{col 65}Min{col 77}Max
  {hline 13}{c +}{hline 32}{c +}{hline 30}
    log_income {c |}{res}       404{txt}{space 10}{res}     5,963{txt}  {c |}    222  -5.926926    8.922658
  {hline 13}{c BT}{hline 32}{c BT}{hline 30}
{col 64}Obs<.
{col 49}{c TLC}{hline 30}
{col 16}{c |}{col 49}{c |} Unique
{col 7}Variable {c |}{col 22}Obs=.{col 32}Obs>.{col 42}Obs<.{col 49}{c |} values{col 65}Min{col 77}Max
  {hline 13}{c +}{hline 32}{c +}{hline 30}
   primiparous {c |}{res}       119{txt}{space 10}{res}     6,248{txt}  {c |}      2          0           1
  {hline 13}{c BT}{hline 32}{c BT}{hline 30}
{com}.   misstable summarize stillbirth
{txt}{col 64}Obs<.
{col 49}{c TLC}{hline 30}
{col 16}{c |}{col 49}{c |} Unique
{col 7}Variable {c |}{col 22}Obs=.{col 32}Obs>.{col 42}Obs<.{col 49}{c |} values{col 65}Min{col 77}Max
  {hline 13}{c +}{hline 32}{c +}{hline 30}
    stillbirth {c |}{res}       279{txt}{space 10}{res}     6,088{txt}  {c |}      2          0           1
  {hline 13}{c BT}{hline 32}{c BT}{hline 30}
{com}.   assert r(N_eq_dot) / (r(N_eq_dot) + r(N_lt_dot)) < 0.05
. {c )-}
{txt}
{com}. 
{txt}end of do-file

{com}. do data/time_outcomes
{txt}
{com}. version 16.1
{txt}
{com}. 
. // Load the data and check its signature is as expected.
. frame create time
{txt}
{com}. frame time {c -(}
.   // Import the data and verify its signature.
.   use "${c -(}fname_time{c )-}", replace
.   datasignature
  {res}241:25(46964):1322369528:1413582791
{com}.   assert r(datasignature) == "${c -(}datasignature_time{c )-}"
. 
.   // Encode/rename arm variable.
.   encode exposure, generate(arm)
.   label variable arm Arm
. 
.   // Rename observer variable.
.   rename observercode observer
{res}{com}. 
.   // Rename cluster identifier variables.
.   rename clinicnumber clusterid
{res}{com}.   label variable clusterid Cluster
. 
.   // Rename the district variable, which was used in stratification.
.   rename district strat_var
{res}{com}. 
.   // Lab availability.
.   label variable lab_available "Lab available"
.   label define lab_available_label 1 "Lab" 0 "No lab"
.   label values lab_available lab_available_label
. 
.   // Compute the cluster size from the trial data. We use the trial data for
.   // simplicity and have verified that these agree with the "baseline" data on
.   // trial size. We divide by 100 because cluster sizes range from about 10 to
.   // about 220, and we want to get regression coefficients that are non-null
.   // within two decimal places! Note that cluster size computation must be
.   // done before the data set is reshaped to long format, or we will count
.   // one enrollment per visit rather than pregnancy.
.   by clusterid, sort: generate cluster_size = _N / 100
. 
.   // Rename the outcomes.
.   rename himwithinconsultation him_time
{res}{com}.   label variable               him_time "HIM time per consultation (mins)"
. 
.   // Transform times to the log scale.
.   foreach y of varlist $time_outcomes {c -(}
{txt}  2{com}.     replace `y' = log(`y' + epsfloat()) // Prevent missing data due to log(0).
{txt}  3{com}.   {c )-}
{txt}(241 real changes made)
{com}. 
.   // Keep only the variables of interest.
.   //// TODO: REINSTATE
>   //// keep $time_outcomes arm clusterid observer $time_adj_var_names
> 
.   // Verify that no data are missing.
.   //// TODO: REINSTATE
>   //// misstable summarize
>   //// assert r(N_lt_dot) == .
> 
.   // TODO: Take logs of the time variables!
. 
. 
.   // TODO: Remember to place a random effect on observer!
. {c )-}
{txt}
{com}. 
{txt}end of do-file

{com}. 
. // Perform imputation.
. // TODO: REINSTATE do data/impute
. 
. // Do estimation.
. // TODO: REINSTATE do estimation/missing          // Calculate percentage of data missing.
. do estimation/mcar             // Test the MCAR hypothesis.
{txt}
{com}. version 16.1
{txt}
{com}. 
. // Test the null hypothesis that the constituent outcomes are jointly MCAR, and
. // the null that the constituent outcomes are jointly CDM (a type of MCAR).
. // P < 0.05 would reject the hypotheses (i.e., as usual, if P>= 0.05, we cannot
. // "conclude" that the data are MCAR or have CDM, merely that we cannot reject
. // those hypotheses).
. frame original {c -(}
.   mcartest y1-y5
{res}{txt}{p 0 6}note: 560 {txt}observations {txt}omitted from EM estimation because of all {txt}imputation variables missing{p_end}
{res}
{txt}Little's MCAR test

Number of obs       = {res}5807
{txt}Chi-square distance = {res}42.4844     
{txt}Degrees of freedom  = {res}34
{txt}Prob > chi-square   = {res}0.1507
{com}.   global p_mcar = r(p)
.   mcartest y1-y5 = i.arm i.strat_var
{res}{txt}{p 0 6}note: 560 {txt}observations {txt}omitted from EM estimation because of all {txt}imputation variables missing{p_end}
{res}
{txt}Little's CDM test

Number of obs       = {res}5807
{txt}Chi-square distance = {res}196.2496    
{txt}Degrees of freedom  = {res}204
{txt}Prob > chi-square   = {res}0.6389
{com}.   global p_cdm  = r(p)
. {c )-}
{txt}
{com}. 
. 
{txt}end of do-file

{com}. // TODO: REINSTATE do estimation/birth_outcomes   // Analyze the birth outcome data.
. // TODO: REINSTATE do estimation/process_outcomes // Analyze process outcome data.
. // TODO: REINSTATE do estimation/margins          // Compute marginal probabilities.
. do estimation/time_outcomes                       // Analyze time and motion data.
{txt}
{com}. version 16.1
{txt}
{com}. 
. frame time {c -(}
.   foreach y of global time_outcomes {c -(}
{txt}  2{com}.       //mixed `y' i.arm $time_adj_vars || observer:, vce(cluster clusterid)
.       mixed `y' i.arm $time_adj_vars || clusterid: || observer:
{txt}  3{com}.       // TODO: The above non-commented code seems fine, and gives identical
.       // estimates to the opposite order of the random effects, but runs faster.
.       estimates store `y'_estimates
{txt}  4{com}.   {c )-}
{res}
{txt}Performing EM optimization: 
{res}
{txt}Performing gradient-based optimization: 
{res}
{txt}Iteration 0:{space 3}log likelihood = {res:-205.17597}  
{res}{txt}Iteration 1:{space 3}log likelihood = {res:-205.16572}  (not concave)
{res}{txt}Iteration 2:{space 3}log likelihood = {res:-205.16571}  (backed up)
{res}
{txt}Computing standard errors:
{res}
{txt}Mixed-effects ML regression{col 49}Number of obs{col 67}={col 69}{res}       241

{txt}{hline 16}{c TT}{hline 44}
{col 17}{c |}{col 23}No. of{col 36}Observations per Group
{col 2}Group Variable{col 17}{c |}{col 23}Groups{col 33}Minimum{col 44}Average{col 55}Maximum
{hline 16}{c +}{hline 44}
{res}{col 7}clusterid{txt}{col 17}{c |}{res}{col 21}      22{col 31}        4{col 42}     11.0{col 53}       26
{col 8}observer{txt}{col 17}{c |}{res}{col 21}      22{col 31}        4{col 42}     11.0{col 53}       26
{txt}{hline 16}{c BT}{hline 44}

{col 49}Wald chi2({res}7{txt}){col 67}={col 70}{res}    19.33
{txt}Log likelihood = {res}-205.16571{col 49}{txt}Prob > chi2{col 67}={col 73}{res}0.0072

{txt}{hline 14}{c TT}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{col 1}     him_time{col 15}{c |}      Coef.{col 27}   Std. Err.{col 39}      z{col 47}   P>|z|{col 55}     [95% Con{col 68}f. Interval]
{hline 14}{c +}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{space 10}arm {c |}
{space 11}B  {c |}{col 15}{res}{space 2}    -0.20{col 27}{space 2}     0.13{col 38}{space 1}   -1.52{col 47}{space 3} 0.13{col 55}{space 4}    -0.46{col 68}{space 3}     0.06
{txt}{space 13} {c |}
{space 4}strat_var {c |}
{space 4}Ramallah  {c |}{col 15}{res}{space 2}     0.47{col 27}{space 2}     0.31{col 38}{space 1}    1.49{col 47}{space 3} 0.14{col 55}{space 4}    -0.15{col 68}{space 3}     1.08
{txt}{space 6}Nablus  {c |}{col 15}{res}{space 2}     0.00{col 27}{space 2}     0.31{col 38}{space 1}    0.00{col 47}{space 3} 1.00{col 55}{space 4}    -0.61{col 68}{space 3}     0.61
{txt}{space 6}Salfit  {c |}{col 15}{res}{space 2}     0.26{col 27}{space 2}     0.28{col 38}{space 1}    0.92{col 47}{space 3} 0.36{col 55}{space 4}    -0.29{col 68}{space 3}     0.80
{txt}{space 7}Jenin  {c |}{col 15}{res}{space 2}    -0.00{col 27}{space 2}     0.26{col 38}{space 1}   -0.01{col 47}{space 3} 0.99{col 55}{space 4}    -0.51{col 68}{space 3}     0.51
{txt}{space 13} {c |}
{space 1}cluster_size {c |}{col 15}{res}{space 2}    -3.17{col 27}{space 2}     1.74{col 38}{space 1}   -1.82{col 47}{space 3} 0.07{col 55}{space 4}    -6.58{col 68}{space 3}     0.25
{txt}{space 13} {c |}
lab_available {c |}
{space 9}Lab  {c |}{col 15}{res}{space 2}    -0.09{col 27}{space 2}     0.13{col 38}{space 1}   -0.67{col 47}{space 3} 0.50{col 55}{space 4}    -0.34{col 68}{space 3}     0.16
{txt}{space 8}_cons {c |}{col 15}{res}{space 2}     2.23{col 27}{space 2}     0.28{col 38}{space 1}    8.00{col 47}{space 3} 0.00{col 55}{space 4}     1.68{col 68}{space 3}     2.77
{txt}{hline 14}{c BT}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}

{hline 29}{c TT}{hline 48}
{col 3}Random-effects Parameters{col 30}{c |}{col 34}Estimate{col 45}Std. Err.{col 59}[95% Conf. Interval]
{hline 29}{c +}{hline 48}
{res}clusterid{txt}: Identity{col 30}{c |}
{space 18}var(_cons) {c |}{res}{col 33}     0.02{col 44}     0.36{col 58}     0.00{col 70} 2.54e+17
{txt}{hline 29}{c +}{hline 48}
{res}observer{txt}: Identity{col 30}{c |}
{space 18}var(_cons) {c |}{res}{col 33}     0.02{col 44}     0.36{col 58}     0.00{col 70} 2.54e+17
{txt}{hline 29}{c +}{hline 48}
{col 16}var(Residual){col 30}{c |}{res}{col 33}     0.30{col 44}     0.03{col 58}     0.25{col 70}     0.36
{txt}{hline 29}{c BT}{hline 48}
LR test vs. linear model:{col 27}chi2({res}2{txt}) = {res}6.28{col 59}{txt}Prob > chi2 ={col 73}{res}0.0433

{txt}{p 0 6 4}Note: {help j_mixedlr##|_new:LR test is conservative} and provided only for reference.{p_end}
{com}. {c )-}
{txt}
{com}. 
{txt}end of do-file

{com}. 
. // Make figures
. // TODO: REINSTATE do figures/imputation
. // TODO: REINSTATE do figures/margins
. 
. // Obtain the git revision hash, which is used in the reports.
. tempfile git_revision_filename
{txt}
{com}. tempname revision_file
{txt}
{com}. shell git rev-parse --short HEAD > "`git_revision_filename'"
{txt}

{com}. file open `revision_file' using `git_revision_filename', read text
{txt}
{com}. file read `revision_file' line
{txt}
{com}. global git_revision = "`macval(line)'"
{txt}
{com}. 
. // Make the report
. // TODO: REINSTATE do reports/report products/report.docx
. 
{txt}end of do-file

{com}. 